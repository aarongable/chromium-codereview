
<link rel="import" href="../../bower_components/polymer-ui-accordion/polymer-ui-accordion.html">

<link rel="import" href="cr-linkified-text.html">
<link rel="import" href="cr-issue-message-reply.html">

<polymer-element name="cr-issue-messages" attributes="messages" cache-csstext>
    <template>
        <link rel="stylesheet" href="cr-issue-messages.css">

        <template if="{{ messages.length }}">
            <polymer-ui-accordion multi selected="{{ [ messages.length - 1 ] }}">
                <template repeat="{{ message, i in messages }}">
                    <polymer-ui-collapsible class="message {{ {approval: message.approval, disapproval: message.disapproval} | tokenList }}">
                        <div class="message-header polymer-ui-collapsible-header" on-tap="{{ scrollMessageToVisibleIfNeeded }}">
                            <div class="message-title">
                                <div class="message-author">{{ message.author.displayName }}</div>
                                <div class="message-preview">{{ message.text | messagePreview }}</div>
                            </div>
                            <div class="message-date">
                                {{ message.date | formatDate }}
                            </div>
                        </div>
                        <div class="message-text">
                            <cr-linkified-text text="{{ message.text }}" pre></cr-linkified-text>
                        </div>
                        <div class="message-toolbar">
                            <cr-issue-message-reply message="{{ message }}"></cr-issue-message-reply>
                        </div>
                    </polymer-ui-collapsible>
                </template>
            </polymer-ui-accordion>
        </template>
    </template>
    <script>
    (function() {
        var REPLY_HEADER = /On \d+\/\d+\/\d+ \d+:\d+:\d+, .*? wrote:/;
        var FILE_HEADER = /https:\/\/codereview.chromium.org\/\d+\/diff\/\d+\/.*/;

        Polymer("cr-issue-messages", {
            messages: null,
            toggleAll: function(options) {
                var messages = toArray(this.shadowRoot.querySelectorAll(".message"));
                messages.forEach(function(message) {
                    message.active = options.active;
                });
            },
            formatDate: function(date) {
                if (!date)
                    return "";
                return date.relative();
            },
            scrollMessageToVisibleIfNeeded: function(event) {
                // If you click the header then scroll the message until you can read it. This is
                // racy with the <polymer-ui-collapsible> animation but it's the best we have
                // until polymer exposes some events. We could listen for on-transitionend but
                // then expand/collapse all would make us do this for each item.
                var message = event.currentTarget.parentNode;
                this.async(function() {
                    message.scrollIntoViewIfNeeded();
                }, null, 350);
            },
            messagePreview: function(text) {
                var lines = text.split("\n");
                var i = 0;
                var j = 0;

                do {
                    j = i;
                    if (lines[i] === "") {
                        ++i;
                    } if (REPLY_HEADER.test(lines[i])) {
                        ++i;
                        while (lines[i].startsWith(">"))
                            ++i;
                    } else if (FILE_HEADER.test(lines[i])) {
                        i += 5;
                    }
                } while (i != j);

                // If we hit the end then it's not clear what's in this reply so
                // just show it all.
                if (i >= text.length)
                    return text;

                return lines.slice(i).join("\n");
            }
        });
    })();
    </script>
</polymer-element>
