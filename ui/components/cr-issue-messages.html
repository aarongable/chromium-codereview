
<link rel="import" href="../../bower_components/polymer-ui-accordion/polymer-ui-accordion.html">
<link rel="import" href="../../bower_components/polymer-ui-toggle-button/polymer-ui-toggle-button.html">

<link rel="import" href="cr-linkified-text.html">
<link rel="import" href="cr-issue-message-reply.html">

<polymer-element name="cr-issue-messages" attributes="messages">
    <template>
        <style>
            :host { display: block; }

            a:link,
            a:visited {
                color: black;
                text-decoration: none;
            }

            a:hover {
                color: #284D8C;
                text-decoration: underline;
            }

            .message {
                border-color: #dfdfdf;
                border-width: 1px 1px 0 1px;
                border-style: solid;
            }

            .message:last-child {
                border-width: 1px;
            }

            .message-text {
                padding: 0.5em 16px;
                white-space: pre-wrap;
                font-family: Monaco, monospace;
            }

            .message-header {
                padding: 0.5em 16px;
                display: flex;
            }

            .message-title {
                flex: 1;
                display: flex;
            }

            .message-author {
                flex-shrink: 0;
                font-weight: bold;
            }

            .message-preview {
                color: #646464;
                white-space: nowrap;
                overflow: hidden;
                margin: 0 1em;
                opacity: 1;
                -webkit-transform: translateZ(0);
                transition: -webkit-transform 0.5s, opacity 0.5s;
            }

            .polymer-ui-collapsible-header {
                cursor: pointer;
                -webkit-user-select: none;
            }

            .message[active] .message-preview {
                opacity: 0;
                transition: -webkit-transform 0.5s, opacity 0.2s;
                -webkit-transform: translateY(2.2em) translateZ(0);
                pointer-events: none;
            }

            .approval {
                background-color: #8fdf5f;
            }

            .approval .message-preview {
                color: #222121;
            }

            .disapproval {
                background-color: #E75D54;
            }

            .disapproval .message-preview {
                color: #F4F4F4;
            }
        </style>

        <template if="{{ messages.length }}">
            <polymer-ui-accordion multi selected="{{ [ messages.length - 1 ] }}">
                <template repeat="{{ message, i in messages }}">
                    <polymer-ui-collapsible class="message">
                        <div class="message-header polymer-ui-collapsible-header {{ {approval: message.approval, disapproval: message.disapproval} | tokenList }}">
                            <div class="message-title">
                                <div class="message-author">{{ message.author.displayName }}</div>
                                <div class="message-preview">{{ message.text | messagePreview }}</div>
                            </div>
                            <div class="message-date">
                                {{ message.date | formatDate }}
                            </div>
                        </div>
                        <div class="message-text"><cr-linkified-text text="{{ message.text }}"></cr-linkified-text></div>
                        <div class="message-toolbar">
                            <cr-issue-message-reply message="{{ message }}"></cr-issue-message-reply>
                        </div>
                    </polymer-ui-collapsible>
                </template>
            </polymer-ui-accordion>
        </template>
    </template>
    <script>
    (function() {
        var REPLY_HEADER = /On \d+\/\d+\/\d+ \d+:\d+:\d+, .*? wrote:/;
        var FILE_HEADER = /https:\/\/codereview.chromium.org\/\d+\/diff\/\d+\/.*/;

        Polymer("cr-issue-messages", {
            messages: null,
            formatDate: function(date) {
                if (!date)
                    return "";
                return date.relative();
            },
            messagePreview: function(text) {
                var lines = text.trim().split("\n");
                var i = 0;

                if (REPLY_HEADER.test(lines[i])) {
                    ++i;
                    while (lines[i].startsWith(">"))
                        ++i;
                }

                if (FILE_HEADER.test(lines[i]))
                    i += 5;

                return lines.slice(i).join("\n");
            }
        });
    })();
    </script>
</polymer-element>
